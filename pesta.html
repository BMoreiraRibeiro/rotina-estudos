<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projeto PESTA - Torre Autom√°tica Airsoft</title>
    <!-- Inline SVG favicon (same as main page) -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%238b5cf6'/%3E%3Ctext x='50' y='60' font-size='56' text-anchor='middle' fill='white'%3E%F0%9F%93%9A%3C/text%3E%3C/svg%3E">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e2e8f0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4);
        }
        
        .header h1 {
            color: #fff;
            margin-bottom: 10px;
            font-size: 2.2em;
        }
        
        .header p {
            color: #fef3c7;
            font-size: 1.1em;
        }
        
        .deadline-banner {
            background: #059669;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin-top: 15px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.5s ease;
        }
        
        .deadline-banner.urgent {
            background: #dc2626;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            background: #1e293b;
            color: #94a3b8;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }
        
        .tab:hover {
            background: #334155;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border-color: #a78bfa;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section {
            background: #0f1624;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #1e293b;
        }
        
        .section h2 {
            color: #a78bfa;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #334155;
        }
        
        .task-category {
            background: #1e293b;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #8b5cf6;
        }
        
        .task-category h3 {
            color: #c4b5fd;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .task-category h3 .progress {
            font-size: 0.8em;
            color: #94a3b8;
        }
        
        .task-item {
            background: #0f1624;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transition: background 0.2s;
        }

        /* Hierarchical level-based layout */
        .task-item {
            padding: 8px 10px;
            margin-bottom: 4px;
            gap: 10px;
            display: flex;
            align-items: center;
            background: #0f1624;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .task-item:hover {
            background: #1a2332;
        }

        /* Indentation by level */
        .task-level-1 {
            padding-left: 10px;
        }

        .task-level-2 {
            padding-left: 34px;
        }

        .task-level-3 {
            padding-left: 58px;
        }

        .task-level-4 {
            padding-left: 82px;
        }

        .task-level-5 {
            padding-left: 106px;
        }

        /* Colors by level */
        .task-level-1 .task-content {
            color: #a78bfa;
            font-weight: 600;
            font-size: 1.05em;
        }

        .task-level-2 .task-content {
            color: #c4b5fd;
            font-weight: 500;
        }

        .task-level-3 .task-content {
            color: #ddd6fe;
        }

        .task-level-4 .task-content {
            color: #cbd5e1;
            font-size: 0.95em;
        }

        .task-level-5 .task-content {
            color: #94a3b8;
            font-size: 0.9em;
        }

        .task-content {
            flex: 1;
            cursor: pointer;
            user-select: none;
        }

        /* Toggle for subtasks */
        .task-toggle {
            border: none;
            background: transparent;
            color: #cbd5e1;
            font-size: 0.9em;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.15s ease;
            flex-shrink: 0;
        }

        .task-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .task-toggle.empty {
            opacity: 0;
            pointer-events: none;
        }

        .subtasks {
            display: none;
            margin-top: 8px;
            padding-left: 26px;
        }

        .subtasks.open {
            display: block;
        }
        
        .task-item:hover {
            background: #1a2332;
        }
        
        .task-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: #10b981;
            flex-shrink: 0;
        }
        
        .task-content {
            flex: 1;
        }
        
        .task-label {
            cursor: pointer;
            user-select: none;
            color: #e2e8f0;
            display: block;
            margin-bottom: 5px;
        }
        
        .task-item input[type="checkbox"]:checked + .task-content .task-label {
            text-decoration: line-through;
            opacity: 0.5;
        }
        
        .task-expand-btn {
            background: #334155;
            color: #94a3b8;
            border: none;
            padding: 4px 12px;
            border-radius: 5px;
            font-size: 0.85em;
            cursor: pointer;
            margin-top: 5px;
        }
        
        .task-expand-btn:hover {
            background: #475569;
        }
        
        .subtasks {
            margin-top: 10px;
            margin-left: 20px;
            padding-left: 15px;
            border-left: 2px solid #334155;
            display: none;
        }
        
        .subtasks.open {
            display: block;
        }
        
        .subtask-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 0;
        }
        
        .subtask-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #10b981;
        }
        
        .subtask-item label {
            cursor: pointer;
            color: #cbd5e1;
            font-size: 0.9em;
        }
        
        .subtask-item input[type="checkbox"]:checked + label {
            text-decoration: line-through;
            opacity: 0.5;
        }
        
        .add-subtask-btn {
            background: #10b981;
            color: white;
            border: none;
            padding: 6px 15px;
            border-radius: 5px;
            font-size: 0.85em;
            cursor: pointer;
            margin-top: 8px;
        }
        
        .add-subtask-btn:hover {
            background: #059669;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            color: #cbd5e1;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            background: #1e293b;
            color: #e2e8f0;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 12px;
            font-family: inherit;
            font-size: 1em;
        }
        
        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #8b5cf6;
        }
        
        .btn {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: transform 0.2s;
            font-weight: 500;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        
        .btn-secondary {
            background: #475569;
        }

        .btn-small {
            background: transparent;
            border: none;
            color: #cbd5e1;
            cursor: pointer;
            padding: 4px 6px;
            font-size: 0.95em;
            border-radius: 4px;
        }

        .btn-small.danger {
            color: #ff6b6b;
        }

        .task-edit-input {
            background: #0b1220;
            color: #e2e8f0;
            border: 1px solid #334155;
            padding: 6px 8px;
            border-radius: 6px;
            font-size: 0.95em;
            width: 60%;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .log-entry {
            background: #1e293b;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #3b82f6;
            position: relative;
        }
        
        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .log-title {
            color: #93c5fd;
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .log-date {
            color: #94a3b8;
            font-size: 0.9em;
        }
        
        .log-subject {
            display: inline-block;
            background: #334155;
            color: #fbbf24;
            padding: 4px 12px;
            border-radius: 5px;
            font-size: 0.85em;
            margin-bottom: 10px;
        }
        
        .log-text {
            color: #cbd5e1;
            line-height: 1.6;
            white-space: pre-wrap;
        }
        
        .log-actions {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .log-action-btn {
            background: #334155;
            color: #94a3b8;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        .log-action-btn:hover {
            background: #475569;
        }
        
        .search-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .search-bar input {
            flex: 1;
            min-width: 250px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #1e293b;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #8b5cf6;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #a78bfa;
        }
        
        .stat-label {
            color: #94a3b8;
            margin-top: 5px;
        }
        
        .progress-bar-container {
            background: #334155;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #10b981, #059669);
            height: 100%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.open {
            display: flex;
        }
        
        .modal-content {
            background: #0f1624;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 2px solid #334155;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h3 {
            color: #a78bfa;
        }
        
        .close-modal {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        
        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 15px;
        }
        
        /* File Upload Styles */
        .file-upload-area {
            background: #1e293b;
            border: 2px dashed #475569;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s;
        }
        
        .file-upload-area:hover {
            border-color: #8b5cf6;
            background: #1e3a5f;
        }
        
        .file-upload-area.drag-over {
            border-color: #10b981;
            background: #064e3b;
        }
        
        .file-list {
            display: grid;
            gap: 10px;
        }
        
        .file-item {
            background: #1e293b;
            padding: 15px 20px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.3s;
            border: 1px solid #334155;
        }
        
        .file-item:hover {
            background: #334155;
            border-color: #8b5cf6;
        }
        
        .file-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }
        
        .file-icon {
            font-size: 2em;
        }
        
        .file-details {
            flex: 1;
        }
        
        .file-name {
            color: #e2e8f0;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .file-meta {
            color: #94a3b8;
            font-size: 0.85em;
        }
        
        .file-actions {
            display: flex;
            gap: 8px;
        }
        
        .upload-progress {
            margin-top: 10px;
        }
        
        .progress-bar {
            background: #334155;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .progress-fill {
            background: linear-gradient(90deg, #10b981, #059669);
            height: 100%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéØ Projeto PESTA</h1>
            <p>Torre Autom√°tica de Airsoft com Computer Vision</p>
            <div class="deadline-banner" id="deadlineBanner">
                <span id="deadlineText">‚ö†Ô∏è DEADLINE: Email Orientador</span>
                <span id="deadlineCounter" style="flex: 1; text-align: right; margin-right: 10px;">-- dias restantes</span>
                <button class="btn-small" onclick="editDeadlineBanner()" title="Editar mensagem e data">‚úèÔ∏è</button>
            </div>
            <div id="firebaseStatus" style="margin-top: 10px; padding: 8px; border-radius: 5px; font-size: 0.9em; text-align: center; display: none;">
                <span id="firebaseStatusText"></span>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview')">üìä Vis√£o Geral</button>
            <button class="tab" onclick="switchTab('tasks')">‚úÖ Tarefas</button>
            <button class="tab" onclick="switchTab('log')">üìù Log de Desenvolvimento</button>
            <!-- <button class="tab" onclick="switchTab('files')">üìé Ficheiros</button> -->
            <button class="tab" onclick="switchTab('resources')">üìö Recursos</button>
        </div>
        
        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">Tarefas Totais</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">Tarefas Conclu√≠das</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalLogs">0</div>
                    <div class="stat-label">Entradas no Log</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="progressPercent">0%</div>
                    <div class="stat-label">Progresso Geral</div>
                </div>
            </div>
            
            <div class="section">
                <h2>üéØ Objetivos do Projeto</h2>
                <div style="background: #1e293b; padding: 20px; border-radius: 10px; line-height: 1.8;">
                    <p style="margin-bottom: 15px;"><strong>Objetivo Principal:</strong> Desenvolver uma torre autom√°tica de airsoft capaz de detectar e acompanhar jogadores usando computer vision e controlo rob√≥tico.</p>
                    
                    <p style="margin-bottom: 10px;"><strong>Componentes Principais:</strong></p>
                    <ul style="margin-left: 20px; color: #cbd5e1;">
                        <li>üîß Estrutura f√≠sica com base girat√≥ria motorizada</li>
                        <li>üé• Sistema de c√¢mara para captura de imagens</li>
                        <li>ü§ñ Raspberry Pi como controlador central</li>
                        <li>üß† Modelo de Computer Vision (YOLO/MobileNet) para dete√ß√£o de jogadores</li>
                        <li>‚öôÔ∏è Sistema de controlo de motores/servos</li>
                        <li>üî´ Integra√ß√£o com mecanismo de disparo de airsoft</li>
                    </ul>
                    
                    <p style="margin-top: 15px;"><strong>Entreg√°veis:</strong></p>
                    <ul style="margin-left: 20px; color: #cbd5e1;">
                        <li>üìÑ Relat√≥rio t√©cnico pormenorizado</li>
                        <li>üìä Poster cient√≠fico</li>
                        <li>üíª C√≥digo fonte e documenta√ß√£o</li>
                        <li>üé• Demonstra√ß√£o funcional do sistema</li>
                    </ul>
                </div>
            </div>
            
            <div class="section">
                <h2>üìÖ Timeline do Projeto</h2>
                <div style="display: grid; gap: 15px;">
                    <div style="background: #7f1d1d; padding: 15px; border-radius: 8px; border-left: 4px solid #dc2626;">
                        <div style="color: #fca5a5; font-weight: bold; margin-bottom: 5px;">üî¥ NOVEMBRO 2025 - Email Orientador</div>
                        <div style="color: #fecaca; font-size: 0.9em;">Contactar docente do ISEP e obter confirma√ß√£o como orientador</div>
                    </div>
                    <div style="background: #422006; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                        <div style="color: #fcd34d; font-weight: bold; margin-bottom: 5px;">üü° DEZEMBRO 2025 - JANEIRO 2026 - Planeamento</div>
                        <div style="color: #fef3c7; font-size: 0.9em;">Arquitetura do sistema, lista de componentes, or√ßamento e primeiros testes</div>
                    </div>
                    <div style="background: #1e3a8a; padding: 15px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                        <div style="color: #93c5fd; font-weight: bold; margin-bottom: 5px;">üîµ FEVEREIRO-MAR√áO 2026 - Desenvolvimento</div>
                        <div style="color: #dbeafe; font-size: 0.9em;">Constru√ß√£o da estrutura, treino do modelo CV, integra√ß√£o hardware/software</div>
                    </div>
                    <div style="background: #1e3a28; padding: 15px; border-radius: 8px; border-left: 4px solid #10b981;">
                        <div style="color: #6ee7b7; font-weight: bold; margin-bottom: 5px;">üü¢ ABRIL-MAIO 2026 - Finaliza√ß√£o</div>
                        <div style="color: #d1fae5; font-size: 0.9em;">Testes finais, documenta√ß√£o, relat√≥rio e poster</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tasks Tab -->
        <div id="tasks" class="tab-content">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">‚úÖ Gest√£o de Tarefas</h2>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="openAddTaskModal()">+ Nova Tarefa</button>
                        <button class="btn btn-secondary" onclick="clearAllTasks()">üóëÔ∏è Limpar Conclu√≠das</button>
                        <button class="btn" onclick="expandAll()" title="Expandir todas as subtarefas">üîΩ Expandir todos</button>
                        <button class="btn" onclick="collapseAll()" title="Recolher todas as subtarefas">üîº Recolher todos</button>
                        <button class="btn" onclick="addCategory()" title="Adicionar assunto">‚ûï Assunto</button>
                    </div>
                </div>
                
                <div class="progress-bar-container" style="margin-bottom: 30px;">
                    <div class="progress-bar" id="taskProgressBar">0%</div>
                </div>
                
                <div id="tasksContainer"></div>
            </div>
        </div>
        
        <!-- Log Tab -->
        <div id="log" class="tab-content">
            <div class="section">
                <h2>üìù Adicionar Entrada ao Log</h2>
                <form id="logForm" onsubmit="addLogEntry(event)">
                    <div class="form-group">
                        <label for="logTitle">T√≠tulo *</label>
                        <input type="text" id="logTitle" required placeholder="Ex: Instala√ß√£o do Raspberry Pi OS">
                    </div>
                    
                    <div class="form-group">
                        <label for="logDate">Data *</label>
                        <input type="date" id="logDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="logSubject">Assunto (Opcional)</label>
                        <select id="logSubject">
                            <option value="">Sem assunto espec√≠fico</option>
                            <option value="Hardware">üîß Hardware</option>
                            <option value="Software">üíª Software</option>
                            <option value="Computer Vision">ü§ñ Computer Vision</option>
                            <option value="Testes">üß™ Testes</option>
                            <option value="Documenta√ß√£o">üìÑ Documenta√ß√£o</option>
                            <option value="Reuni√µes">üë• Reuni√µes</option>
                            <option value="Problemas">‚ö†Ô∏è Problemas</option>
                            <option value="Conquistas">üéâ Conquistas</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="logText">Descri√ß√£o *</label>
                        <textarea id="logText" required placeholder="Descreve o que fizeste, problemas encontrados, solu√ß√µes implementadas, pr√≥ximos passos..."></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-success">üíæ Guardar Entrada</button>
                </form>
            </div>
            
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <h2 style="margin: 0;">üìö Hist√≥rico de Logs</h2>
                    <div class="btn-group">
                        <button class="btn" onclick="downloadAllLogs()">‚¨áÔ∏è Download Todos</button>
                        <button class="btn btn-secondary" onclick="downloadSelectedLogs()">‚¨áÔ∏è Download Selecionados</button>
                        <button class="btn btn-danger" onclick="clearAllLogs()">üóëÔ∏è Limpar Todos</button>
                    </div>
                </div>
                
                <div class="search-bar">
                    <input type="text" id="searchLogs" placeholder="üîç Pesquisar logs..." onkeyup="filterLogs()">
                    <select id="filterSubject" onchange="filterLogs()">
                        <option value="">Todos os assuntos</option>
                        <option value="Hardware">üîß Hardware</option>
                        <option value="Software">üíª Software</option>
                        <option value="Computer Vision">ü§ñ Computer Vision</option>
                        <option value="Testes">üß™ Testes</option>
                        <option value="Documenta√ß√£o">üìÑ Documenta√ß√£o</option>
                        <option value="Reuni√µes">üë• Reuni√µes</option>
                        <option value="Problemas">‚ö†Ô∏è Problemas</option>
                        <option value="Conquistas">üéâ Conquistas</option>
                    </select>
                </div>
                
                <div id="logsContainer"></div>
            </div>
        </div>
        
        <!-- Files Tab (TEMPORARIAMENTE DESATIVADO)
        <div id="files" class="tab-content">
            <div class="section">
                <h2>üìé Gest√£o de Ficheiros</h2>
                <p style="color: #94a3b8; margin-bottom: 20px;">Fa√ßa upload de ficheiros Word, PDF e outros documentos para o Firebase Storage</p>
                
                <div class="file-upload-area" id="fileUploadArea">
                    <div style="font-size: 3em; margin-bottom: 10px;">üì§</div>
                    <h3 style="color: #a78bfa; margin-bottom: 10px;">Arraste ficheiros aqui ou clique para selecionar</h3>
                    <p style="color: #94a3b8; margin-bottom: 15px;">Formatos suportados: PDF, DOCX, DOC, TXT, PNG, JPG, ZIP, etc.</p>
                    <input type="file" id="fileInput" style="display: none;" multiple onchange="handleFileSelect(event)">
                    <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        üìÅ Selecionar Ficheiros
                    </button>
                    <div id="uploadProgress" class="upload-progress" style="display: none;">
                        <div style="color: #94a3b8; font-size: 0.9em; margin-bottom: 5px;">
                            <span id="uploadStatus">A enviar...</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #a78bfa;">üìö Ficheiros Guardados</h3>
                    <button class="btn btn-secondary" onclick="loadFiles()">üîÑ Atualizar Lista</button>
                </div>
                
                <div id="filesContainer" class="file-list">
                    <div class="empty-state">
                        <div class="empty-state-icon">üìÇ</div>
                        <p>Nenhum ficheiro carregado ainda</p>
                    </div>
                </div>
            </div>
        </div>
        -->
        
        <!-- Resources Tab -->
        <div id="resources" class="tab-content">
            <div class="section">
                <h2>üìö Recursos T√©cnicos</h2>
                
                <div class="task-category">
                    <h3>ü§ñ Computer Vision & Machine Learning</h3>
                    <div style="line-height: 1.8; color: #cbd5e1;">
                        <p style="margin-bottom: 10px;"><strong>YOLO (You Only Look Once):</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px;">
                            <li><a href="https://github.com/ultralytics/yolov5" target="_blank" style="color: #60a5fa;">YOLOv5 - Ultralytics</a> - R√°pido e eficiente para Raspberry Pi</li>
                            <li><a href="https://github.com/ultralytics/yolov8" target="_blank" style="color: #60a5fa;">YOLOv8 - Ultralytics</a> - Vers√£o mais recente</li>
                            <li><a href="https://docs.ultralytics.com/" target="_blank" style="color: #60a5fa;">Documenta√ß√£o YOLO</a></li>
                        </ul>
                        
                        <p style="margin-bottom: 10px;"><strong>MobileNet & TensorFlow:</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px;">
                            <li><a href="https://github.com/tensorflow/models/tree/master/research/object_detection" target="_blank" style="color: #60a5fa;">TensorFlow Object Detection API</a></li>
                            <li><a href="https://www.tensorflow.org/lite/examples/object_detection/overview" target="_blank" style="color: #60a5fa;">TensorFlow Lite - Otimizado para dispositivos embarcados</a></li>
                        </ul>
                        
                        <p style="margin-bottom: 10px;"><strong>Dataset & Annotation:</strong></p>
                        <ul style="margin-left: 20px;">
                            <li><a href="https://www.makesense.ai/" target="_blank" style="color: #60a5fa;">Makesense.ai</a> - Anota√ß√£o online de imagens</li>
                            <li><a href="https://github.com/tzutalin/labelImg" target="_blank" style="color: #60a5fa;">LabelImg</a> - Ferramenta desktop para anotar</li>
                            <li><a href="https://roboflow.com/" target="_blank" style="color: #60a5fa;">Roboflow</a> - Gest√£o de datasets e augmentation</li>
                        </ul>
                    </div>
                </div>
                
                <div class="task-category">
                    <h3>üîß Raspberry Pi & Hardware</h3>
                    <div style="line-height: 1.8; color: #cbd5e1;">
                        <p style="margin-bottom: 10px;"><strong>Controlo de GPIO:</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px;">
                            <li><a href="https://gpiozero.readthedocs.io/" target="_blank" style="color: #60a5fa;">GPIOZero Documentation</a> - Biblioteca Python para GPIO</li>
                            <li><a href="https://pinout.xyz/" target="_blank" style="color: #60a5fa;">Pinout.xyz</a> - Mapa de pinos Raspberry Pi</li>
                        </ul>
                        
                        <p style="margin-bottom: 10px;"><strong>Motores & Servos:</strong></p>
                        <ul style="margin-left: 20px; margin-bottom: 15px;">
                            <li><a href="https://learn.adafruit.com/adafruit-16-channel-pwm-servo-hat-for-raspberry-pi" target="_blank" style="color: #60a5fa;">Adafruit Servo HAT</a> - Controlar at√© 16 servos</li>
                            <li><a href="https://www.pololu.com/docs/0J40" target="_blank" style="color: #60a5fa;">Pololu Motor Drivers</a></li>
                        </ul>
                        
                        <p style="margin-bottom: 10px;"><strong>C√¢maras:</strong></p>
                        <ul style="margin-left: 20px;">
                            <li><a href="https://picamera.readthedocs.io/" target="_blank" style="color: #60a5fa;">PiCamera Documentation</a> - Para Raspberry Pi Camera Module</li>
                            <li><a href="https://opencv.org/" target="_blank" style="color: #60a5fa;">OpenCV</a> - Para qualquer c√¢mara USB</li>
                        </ul>
                    </div>
                </div>
                
                <div class="task-category">
                    <h3>üìñ Tutoriais & Guias</h3>
                    <div style="line-height: 1.8; color: #cbd5e1;">
                        <ul style="margin-left: 20px;">
                            <li><a href="https://www.youtube.com/c/NicholasRenotte" target="_blank" style="color: #60a5fa;">Nicholas Renotte</a> - Excelentes tutoriais de CV</li>
                            <li><a href="https://www.pyimagesearch.com/" target="_blank" style="color: #60a5fa;">PyImageSearch</a> - Blog de Computer Vision</li>
                            <li><a href="https://realpython.com/face-detection-in-python-using-a-webcam/" target="_blank" style="color: #60a5fa;">Real Python - Face Detection</a></li>
                            <li><a href="https://github.com/mikeshardmind/raspberry-pi-picamera-yolo" target="_blank" style="color: #60a5fa;">YOLO com PiCamera</a> - Exemplo completo</li>
                        </ul>
                
                        <!-- Resources management: add new resource and bibliography (IEEE) -->
                        <div style="margin-top: 20px; padding: 12px; background: #0b1220; border-radius: 8px; border: 1px solid #1e293b;">
                            <h4 style="color: #c4b5fd; margin-bottom: 10px;">‚ûï Adicionar Recurso / Bibliografia</h4>
                            <form id="addResourceForm" onsubmit="addResource(event)" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; align-items: end;">
                                <div>
                                    <label style="font-size:0.85em; color:#94a3b8">Autores</label>
                                    <input type="text" id="resAuthors" placeholder="Ex: A. Silva; B. Pereira" style="width:100%; padding:8px; border-radius:6px; background:#0f1624; color:#e2e8f0; border:1px solid #334155;">
                                </div>
                                <div>
                                    <label style="font-size:0.85em; color:#94a3b8">T√≠tulo</label>
                                    <input type="text" id="resTitle" placeholder="T√≠tulo do recurso" style="width:100%; padding:8px; border-radius:6px; background:#0f1624; color:#e2e8f0; border:1px solid #334155;">
                                </div>
                                <div>
                                    <label style="font-size:0.85em; color:#94a3b8">Ve√≠culo / Fonte</label>
                                    <input type="text" id="resVenue" placeholder="Revista / Site / Confer√™ncia" style="width:100%; padding:8px; border-radius:6px; background:#0f1624; color:#e2e8f0; border:1px solid #334155;">
                                </div>
                                <div>
                                    <label style="font-size:0.85em; color:#94a3b8">Ano</label>
                                    <input type="text" id="resYear" placeholder="2021" style="width:100%; padding:8px; border-radius:6px; background:#0f1624; color:#e2e8f0; border:1px solid #334155;">
                                </div>
                                <div style="grid-column: 1 / -1; display:flex; gap:8px;">
                                    <input type="text" id="resUrl" placeholder="https://... (opcional)" style="flex:1; padding:8px; border-radius:6px; background:#0f1624; color:#e2e8f0; border:1px solid #334155;">
                                    <button class="btn" type="submit" style="background:#8b5cf6; color:white; padding:8px 12px; border-radius:6px;">Adicionar</button>
                                    <button type="button" class="btn" onclick="exportIEEE()" style="background:#10b981; color:white; padding:8px 12px; border-radius:6px;">Export IEEE</button>
                                </div>
                            </form>

                            <div id="bibliography" style="margin-top:12px; color:#cbd5e1;">
                                <h4 style="color:#a78bfa; margin-bottom:6px;">Bibliografia (IEEE)</h4>
                                <ol id="bibList" style="padding-left: 20px; color:#e2e8f0;"></ol>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Task Modal -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Nova Tarefa</h3>
                <button class="close-modal" onclick="closeAddTaskModal()">‚úï</button>
            </div>
            <form id="addTaskForm" onsubmit="addNewTask(event)">
                <div class="form-group">
                    <label for="taskCategory">Categoria *</label>
                    <select id="taskCategory" required>
                        <option value="Email & Orientador">üìß Email & Orientador</option>
                        <option value="Hardware">üîß Hardware</option>
                        <option value="Software">üíª Software</option>
                        <option value="Computer Vision">ü§ñ Computer Vision</option>
                        <option value="Documenta√ß√£o">üìÑ Documenta√ß√£o</option>
                        <option value="Outro">üìå Outro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskName">Nome da Tarefa *</label>
                    <input type="text" id="taskName" required placeholder="Ex: Treinar modelo YOLO com dataset personalizado">
                </div>
                <button type="submit" class="btn btn-success">Adicionar</button>
            </form>
        </div>
    </div>
    
    <!-- Firebase Configuration (external file) -->
    <script src="firebase-config.js"></script>
    
    <script>
        // ===== FIREBASE INITIALIZATION =====
        
        // Inicializar Firebase
        let db = null;
        let storage = null;
        let firebaseEnabled = false;
        
        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            storage = firebase.storage();
            firebaseEnabled = true;
            console.log('‚úÖ Firebase conectado');
        } catch (error) {
            console.warn('‚ö†Ô∏è Firebase n√£o configurado. Usando localStorage apenas.', error);
            firebaseEnabled = false;
        }
        
        // ===== DATA MIGRATION =====
        // Migrate old data structure (subtasks -> children)
        function migrateTaskStructure(tasks) {
            function migrate(task) {
                // Convert subtasks to children
                if (task.subtasks !== undefined) {
                    task.children = task.subtasks;
                    delete task.subtasks;
                }
                // Ensure children exists
                if (!task.children) task.children = [];
                // Ensure collapsed exists
                if (task.collapsed === undefined) task.collapsed = false;
                // Recursively migrate children
                if (task.children && task.children.length > 0) {
                    task.children.forEach(child => migrate(child));
                }
            }
            
            for (const category in tasks) {
                tasks[category].forEach(task => migrate(task));
            }
            return tasks;
        }
        
        // Initialize
        let tasks = {};
        let categoriesOrder = [];
        let logs = [];
        let selectedLogs = new Set();
        let isLoading = true;
        
        // Load tasks on startup
        (async function initializeApp() {
            const statusEl = document.getElementById('firebaseStatus');
            const statusTextEl = document.getElementById('firebaseStatusText');
            
            if (firebaseEnabled) {
                statusEl.style.display = 'block';
                statusEl.style.background = '#1e40af';
                statusTextEl.textContent = 'üîÑ Sincronizando com Firebase...';
                
                await loadTasksFromFirebase();
                // load meta (order/banner/date) if available
                try {
                    const metaDoc = await db.collection('pesta').doc('meta').get();
                    if (metaDoc.exists) {
                        const md = metaDoc.data() || {};
                        categoriesOrder = md.order || Object.keys(tasks || {});
                        if (md.banner) {
                            const bannerEl = document.getElementById('deadlineText');
                            if (bannerEl) bannerEl.textContent = md.banner;
                            localStorage.setItem('pestaBannerText', md.banner);
                        }
                        if (md.deadlineDate) {
                            localStorage.setItem('pestaDeadlineDate', md.deadlineDate);
                        }
                    } else {
                        categoriesOrder = Object.keys(tasks || {});
                        // persist default meta
                        await db.collection('pesta').doc('meta').set({ order: categoriesOrder });
                    }
                    // cache locally
                    localStorage.setItem('pestaCategoriesOrder', JSON.stringify(categoriesOrder));
                } catch (e) {
                    console.warn('Erro ao carregar meta:', e);
                    categoriesOrder = JSON.parse(localStorage.getItem('pestaCategoriesOrder')) || Object.keys(tasks || {});
                }
                
                statusEl.style.background = '#059669';
                statusTextEl.textContent = '‚úÖ Sincronizado com Firebase';
                setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
            } else {
                tasks = JSON.parse(localStorage.getItem('pestaTasks')) || createDefaultTasks();
                tasks = migrateTaskStructure(tasks);
                categoriesOrder = JSON.parse(localStorage.getItem('pestaCategoriesOrder')) || Object.keys(tasks || {});
                
                statusEl.style.display = 'block';
                statusEl.style.background = '#dc2626';
                statusTextEl.textContent = '‚ö†Ô∏è Firebase n√£o configurado - usando apenas localStorage';
                setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
                // load banner text and date from localStorage if available
                const savedBanner = localStorage.getItem('pestaBannerText');
                if (savedBanner) {
                    const bannerEl = document.getElementById('deadlineText');
                    if (bannerEl) bannerEl.textContent = savedBanner;
                }
            }
            
            logs = JSON.parse(localStorage.getItem('pestaLogs')) || [];
            isLoading = false;
            
            // Initial render
            updateDeadline();
            renderTasks();
            renderLogs();
        })();

        // Save meta (order/banner)
        async function saveMeta() {
            // persist locally
            localStorage.setItem('pestaCategoriesOrder', JSON.stringify(categoriesOrder));
            if (firebaseEnabled) {
                try {
                    await db.collection('pesta').doc('meta').set({ order: categoriesOrder }, { merge: true });
                } catch (e) {
                    console.warn('Erro ao guardar meta no Firebase', e);
                }
            }
        }
        
        function createDefaultTasks() {
            return {
                'Email & Orientador': [
                    { id: 1, name: 'Definir tema exato', completed: true, collapsed: false, children: [] },
                    { id: 2, name: 'Escrever email proposta', completed: false, collapsed: false, children: [] },
                    { id: 3, name: 'Identificar 2-3 docentes poss√≠veis', completed: false, collapsed: false, children: [] },
                    { id: 4, name: 'Enviar email (AT√â 30 NOV!)', completed: false, collapsed: false, children: [] },
                    { id: 5, name: 'Obter resposta positiva', completed: false, collapsed: false, children: [] }
                ],
                'Hardware': [
                    { id: 6, name: 'Desenhar estrutura base', completed: false, collapsed: false, children: [] },
                    { id: 7, name: 'Lista completa de componentes', completed: false, collapsed: false, children: [] },
                    { id: 8, name: 'Or√ßamento e compras', completed: false, collapsed: false, children: [] },
                    { id: 9, name: 'Construir estrutura f√≠sica', completed: false, collapsed: false, children: [] },
                    { id: 10, name: 'Integrar base girat√≥ria motorizada', completed: false, collapsed: false, children: [] },
                    { id: 11, name: 'Montar sistema de disparo', completed: false, collapsed: false, children: [] }
                ],
                'Software': [
                    { id: 12, name: 'Setup Raspberry Pi + OS', completed: false, collapsed: false, children: [] },
                    { id: 13, name: 'Testar c√¢mara e captura v√≠deo', completed: false, collapsed: false, children: [] },
                    { id: 14, name: 'C√≥digo controlo motores', completed: false, collapsed: false, children: [] },
                    { id: 15, name: 'Integra√ß√£o CV + controlo f√≠sico', completed: false, collapsed: false, children: [] }
                ],
                'Computer Vision': [
                    { id: 16, name: 'Recolher dataset', completed: false, collapsed: false, children: [] },
                    { id: 17, name: 'Anotar/label dataset', completed: false, collapsed: false, children: [] },
                    { id: 18, name: 'Escolher modelo (YOLO/MobileNet)', completed: false, collapsed: false, children: [] },
                    { id: 19, name: 'Treinar modelo de dete√ß√£o', completed: false, collapsed: false, children: [] },
                    { id: 20, name: 'Otimizar para Raspberry Pi', completed: false, collapsed: false, children: [] }
                ],
                'Documenta√ß√£o': [
                    { id: 21, name: 'Estrutura do relat√≥rio', completed: false, collapsed: false, children: [] },
                    { id: 22, name: 'Introdu√ß√£o + Estado da Arte', completed: false, collapsed: false, children: [
                        { id: 29, name: 'Sele√ß√£o de projetos similares para estado da arte', completed: false, collapsed: false, children: [] },
                        { id: 30, name: 'Criar quadro comparativo: pontos fortes e objetivos de cada projeto', completed: false, collapsed: false, children: [] },
                        { id: 31, name: 'Criar quadro de caracter√≠sticas t√©cnicas comparativas', completed: false, collapsed: false, children: [] }
                    ] },
                    { id: 23, name: 'Metodologia + Arquitetura', completed: false, collapsed: false, children: [] },
                    { id: 24, name: 'Implementa√ß√£o', completed: false, collapsed: false, children: [] },
                    { id: 25, name: 'Testes e Resultados', completed: false, collapsed: false, children: [] },
                    { id: 26, name: 'Conclus√µes + Trabalho Futuro', completed: false, collapsed: false, children: [] },
                    { id: 27, name: 'Criar poster cient√≠fico', completed: false, collapsed: false, children: [] },
                    { id: 28, name: 'Revis√£o final relat√≥rio', completed: false, collapsed: false, children: [] },
                    { id: 32, name: 'Verificar possibilidade upload ficheiros (Word/PDF) para BD', completed: false, collapsed: false, children: [] }
                ]
            };
        }
        
        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'tasks') {
                renderTasks();
            } else if (tabName === 'log') {
                renderLogs();
            } else if (tabName === 'overview') {
                updateStats();
            } else if (tabName === 'files') {
                loadFiles();
            }
        }
        
        // Deadline counter
        function updateDeadline() {
            // Carregar data salva ou usar default
            const savedDate = localStorage.getItem('pestaDeadlineDate') || '2025-11-30';
            const deadline = new Date(savedDate);
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to midnight for accurate day counting
            deadline.setHours(0, 0, 0, 0);
            
            const diffTime = deadline - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            const counter = document.getElementById('deadlineCounter');
            const banner = document.getElementById('deadlineBanner');
            
            if (counter) {
                if (diffDays > 0) {
                    counter.textContent = `${diffDays} dia${diffDays !== 1 ? 's' : ''} restante${diffDays !== 1 ? 's' : ''}`;
                } else if (diffDays === 0) {
                    counter.textContent = 'HOJE!';
                } else {
                    counter.textContent = 'PRAZO EXPIRADO!';
                }
            }
            
            // Mudar cor do banner baseado na proximidade
            if (banner) {
                if (diffDays <= 2 && diffDays >= 0) {
                    banner.classList.add('urgent');
                } else if (diffDays < 0) {
                    banner.classList.add('urgent');
                } else {
                    banner.classList.remove('urgent');
                }
            }
        }

        // Edit the deadline/banner text and date
        async function editDeadlineBanner() {
            const el = document.getElementById('deadlineText');
            const currentText = el ? el.textContent : '‚ö†Ô∏è DEADLINE: Email Orientador';
            const currentDate = localStorage.getItem('pestaDeadlineDate') || '2025-11-30';
            
            const newText = prompt('Editar mensagem do banner:', currentText);
            if (newText === null) return; // cancelled
            
            const newDate = prompt('Editar data limite (formato: YYYY-MM-DD):', currentDate);
            if (newDate === null) return; // cancelled
            
            // Validar data
            const dateTest = new Date(newDate);
            if (isNaN(dateTest.getTime())) {
                alert('‚ùå Data inv√°lida! Use o formato YYYY-MM-DD (ex: 2025-12-31)');
                return;
            }
            
            // Atualizar interface
            if (el) el.textContent = newText;
            localStorage.setItem('pestaBannerText', newText);
            localStorage.setItem('pestaDeadlineDate', newDate);
            
            // Salvar no Firebase
            if (firebaseEnabled) {
                try {
                    await db.collection('pesta').doc('meta').set({ 
                        banner: newText,
                        deadlineDate: newDate 
                    }, { merge: true });
                } catch (e) {
                    console.warn('Erro ao guardar banner no Firebase', e);
                }
            }
            
            // Atualizar contador imediatamente
            updateDeadline();
        }
        
        // Tasks management - Hierarchical recursive rendering
        function renderTasks() {
            const container = document.getElementById('tasksContainer');
            container.innerHTML = '';
            
            // Render according to categoriesOrder (allows custom ordering)
            for (const category of (categoriesOrder.length ? categoriesOrder : Object.keys(tasks))) {
                const taskList = tasks[category] || [];
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'task-category';
                
                // Count completed including all children
                const { total, completed } = countTasksRecursive(taskList);
                
                const categoryHeader = document.createElement('h3');
                categoryHeader.innerHTML = `
                    ${escapeHtml(category)}
                    <span class="progress">${completed}/${total}</span>
                `;
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn-small danger';
                deleteBtn.title = 'Apagar assunto';
                deleteBtn.innerHTML = 'üóëÔ∏è';
                deleteBtn.onclick = () => deleteCategory(category);
                // move up / down buttons
                const moveUpBtn = document.createElement('button');
                moveUpBtn.className = 'btn-small';
                moveUpBtn.title = 'Mover para cima';
                moveUpBtn.innerHTML = '‚¨ÜÔ∏è';
                moveUpBtn.onclick = () => { moveCategoryUp(category); };

                const moveDownBtn = document.createElement('button');
                moveDownBtn.className = 'btn-small';
                moveDownBtn.title = 'Mover para baixo';
                moveDownBtn.innerHTML = '‚¨áÔ∏è';
                moveDownBtn.onclick = () => { moveCategoryDown(category); };

                categoryHeader.appendChild(moveUpBtn);
                categoryHeader.appendChild(moveDownBtn);
                categoryHeader.appendChild(deleteBtn);
                
                categoryDiv.appendChild(categoryHeader);
                
                const taskListUl = document.createElement('div');
                taskListUl.style.display = 'flex';
                taskListUl.style.flexDirection = 'column';
                taskListUl.style.gap = '2px';
                
                // Render each top-level task recursively
                taskList.forEach(task => renderTask(task, taskListUl, 1, category));
                
                categoryDiv.appendChild(taskListUl);
                container.appendChild(categoryDiv);
            }
            
            updateTaskProgress();
        }
        
        // Recursive function to render a task and its children
        function renderTask(task, parentElement, level, category) {
            const taskDiv = document.createElement('div');
            taskDiv.className = `task-item task-level-${level}`;
            taskDiv.dataset.taskId = task.id;
            
            // Toggle button (‚ñº)
            const toggle = document.createElement('button');
            toggle.className = `task-toggle ${task.children.length === 0 ? 'empty' : ''} ${task.collapsed ? 'collapsed' : ''}`;
            toggle.innerHTML = '‚ñº';
            toggle.onclick = () => toggleTaskCollapse(task.id);
            
            // Checkbox
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'task-checkbox';
            checkbox.checked = task.completed;
            checkbox.onchange = () => toggleTaskComplete(task.id);
            
            // Content
            const content = document.createElement('span');
            content.className = 'task-content';
            content.id = `item-label-${task.id}`;
            content.textContent = task.name;
            if (task.completed) {
                content.style.textDecoration = 'line-through';
                content.style.opacity = '0.5';
            }
            
            // Edit button
            const editBtn = document.createElement('button');
            editBtn.className = 'btn-small';
            editBtn.title = 'Editar';
            editBtn.innerHTML = '‚úèÔ∏è';
            editBtn.onclick = () => startEdit(task.id);
            
            // Delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn-small danger';
            deleteBtn.title = 'Apagar';
            deleteBtn.innerHTML = 'üóëÔ∏è';
            deleteBtn.onclick = () => deleteItemById(task.id);
            
            // Add child button
            const addChildBtn = document.createElement('button');
            addChildBtn.className = 'add-subtask-btn';
            addChildBtn.innerHTML = '+ Sub';
            addChildBtn.onclick = () => addSubtask(task.id);
            
            // Assemble
            taskDiv.appendChild(toggle);
            taskDiv.appendChild(checkbox);
            taskDiv.appendChild(content);
            taskDiv.appendChild(editBtn);
            taskDiv.appendChild(deleteBtn);
            taskDiv.appendChild(addChildBtn);
            
            parentElement.appendChild(taskDiv);
            
            // RECURSION: Render children if not collapsed
            if (task.children && task.children.length > 0 && !task.collapsed) {
                task.children.forEach(child => renderTask(child, parentElement, level + 1, category));
            }
        }
        
        // Count total and completed tasks recursively
        function countTasksRecursive(taskList) {
            let total = 0;
            let completed = 0;
            
            function count(tasks) {
                tasks.forEach(task => {
                    total++;
                    if (task.completed) completed++;
                    if (task.children && task.children.length > 0) {
                        count(task.children);
                    }
                });
            }
            
            count(taskList);
            return { total, completed };
        }
        
        // Toggle task completion (marks all children with same state)
        function toggleTaskComplete(taskId) {
            function findAndToggle(taskList) {
                for (let task of taskList) {
                    if (task.id === taskId) {
                        task.completed = !task.completed;
                        
                        // Mark ALL children with the same state
                        function markChildren(t, completed) {
                            t.completed = completed;
                            if (t.children && t.children.length > 0) {
                                t.children.forEach(child => markChildren(child, completed));
                            }
                        }
                        markChildren(task, task.completed);
                        return true;
                    }
                    if (task.children && task.children.length > 0) {
                        if (findAndToggle(task.children)) return true;
                    }
                }
                return false;
            }
            
            for (const category in tasks) {
                if (findAndToggle(tasks[category])) break;
            }
            saveTasks();
            renderTasks();
            updateStats();
        }
        
        // Toggle expand/collapse for task children
        function toggleTaskCollapse(taskId) {
            function findAndToggle(taskList) {
                for (let task of taskList) {
                    if (task.id === taskId) {
                        task.collapsed = !task.collapsed;
                        return true;
                    }
                    if (task.children && task.children.length > 0) {
                        if (findAndToggle(task.children)) return true;
                    }
                }
                return false;
            }
            
            for (const category in tasks) {
                if (findAndToggle(tasks[category])) break;
            }
            saveTasks();
            renderTasks();
        }

        // Add / remove categories (assuntos)
        function addCategory() {
            const name = prompt('Nome do novo assunto (ex: Desenvolvimento, Documenta√ß√£o):');
            if (!name) return;
            const trimmed = name.trim();
            if (!trimmed) return;
            if (tasks.hasOwnProperty(trimmed)) { alert('Assunto j√° existe'); return; }
            tasks[trimmed] = [];
            // add to ordering
            categoriesOrder.push(trimmed);
            saveMeta();
            saveTasks();
            renderTasks();
        }

        function deleteCategory(category) {
            if (!confirm(`Apagar o assunto "${category}" e todas as suas tarefas?`)) return;
            if (tasks.hasOwnProperty(category)) {
                delete tasks[category];
                // remove from ordering
                const idx = categoriesOrder.indexOf(category);
                if (idx !== -1) categoriesOrder.splice(idx, 1);
                saveMeta();
                saveTasks();
                renderTasks();
            }
        }

        function moveCategoryUp(category) {
            const idx = categoriesOrder.indexOf(category);
            if (idx > 0) {
                const tmp = categoriesOrder[idx - 1];
                categoriesOrder[idx - 1] = categoriesOrder[idx];
                categoriesOrder[idx] = tmp;
                saveMeta();
                renderTasks();
                updateStats();
            }
        }

        function moveCategoryDown(category) {
            const idx = categoriesOrder.indexOf(category);
            if (idx !== -1 && idx < categoriesOrder.length - 1) {
                const tmp = categoriesOrder[idx + 1];
                categoriesOrder[idx + 1] = categoriesOrder[idx];
                categoriesOrder[idx] = tmp;
                saveMeta();
                renderTasks();
                updateStats();
            }
        }


        
        // Add a child task
        function addSubtask(parentId) {
            const name = prompt('Nome da subtarefa:');
            if (!name || !name.trim()) return;
            
            const newTask = {
                id: getNextId(),
                name: name.trim(),
                completed: false,
                collapsed: false,
                children: []
            };
            
            function findAndAdd(taskList) {
                for (let task of taskList) {
                    if (task.id === parentId) {
                        if (!task.children) task.children = [];
                        task.children.push(newTask);
                        return true;
                    }
                    if (task.children && task.children.length > 0) {
                        if (findAndAdd(task.children)) return true;
                    }
                }
                return false;
            }
            
            for (const category in tasks) {
                if (findAndAdd(tasks[category])) break;
            }
            
            saveTasks();
            renderTasks();
        }

        // Generate and persist unique ids for tasks/children
        function getNextId() {
            if (!window.pestaNextId) {
                // compute max id from current tasks
                let maxId = 0;
                for (const list of Object.values(tasks)) {
                    for (const t of list) {
                        if (t.id && t.id > maxId) maxId = t.id;
                        function scanChildren(children) {
                            for (const c of children || []) {
                                if (c.id && c.id > maxId) maxId = c.id;
                                if (c.children) scanChildren(c.children);
                            }
                        }
                        if (t.children) scanChildren(t.children);
                    }
                }
                window.pestaNextId = maxId + 1;
            }
            const id = window.pestaNextId++;
            localStorage.setItem('pestaNextId', String(window.pestaNextId));
            return id;
        }

        // Find an item by id across tasks and children. Returns {item, parentArray, category}
        function findItemById(id) {
            for (const [category, list] of Object.entries(tasks)) {
                // check top-level tasks
                for (const t of list) {
                    if (t.id === id) return { item: t, parentArray: list, category };
                    // recursively search children
                    const found = searchInChildren(t.children, id, category);
                    if (found) return found;
                }
            }
            return null;
        }

        // Helper to recursively search children
        function searchInChildren(children, id, category) {
            if (!children || children.length === 0) return null;
            for (const child of children) {
                if (child.id === id) return { item: child, parentArray: children, category };
                const found = searchInChildren(child.children, id, category);
                if (found) return found;
            }
            return null;
        }



        // Expand or collapse all tasks
        function expandAll() {
            function expand(taskList) {
                taskList.forEach(task => {
                    task.collapsed = false;
                    if (task.children && task.children.length > 0) {
                        expand(task.children);
                    }
                });
            }
            
            for (const category in tasks) {
                expand(tasks[category]);
            }
            saveTasks();
            renderTasks();
        }

        function collapseAll() {
            function collapse(taskList) {
                taskList.forEach(task => {
                    task.collapsed = true;
                    if (task.children && task.children.length > 0) {
                        collapse(task.children);
                    }
                });
            }
            
            for (const category in tasks) {
                collapse(tasks[category]);
            }
            saveTasks();
            renderTasks();
        }

                // Utility: escape HTML when injecting into innerHTML
                function escapeHtml(str) {
                    if (!str && str !== '') return '';
                    return String(str)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                }

                // Start inline edit for an item (task or subtask)
                function startEdit(id) {
                    const label = document.getElementById(`item-label-${id}`);
                    if (!label) return;
                    const current = label.textContent || '';
                    // replace label with input (we'll handle save on blur or Enter)
                    label.outerHTML = `<input id="item-input-${id}" class="task-edit-input" type="text" value="${escapeHtml(current)}" onblur="saveEdit(${id})" onkeydown="handleEditKey(event, ${id})" />`;
                    const input = document.getElementById(`item-input-${id}`);
                    if (input) { input.focus(); input.select(); }
                }

                function handleEditKey(e, id) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveEdit(id);
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelEdit(id);
                    }
                }

                function saveEdit(id) {
                    const input = document.getElementById(`item-input-${id}`);
                    if (!input) return;
                    const val = input.value.trim();
                    if (val === '') { alert('O nome n√£o pode ficar vazio'); input.focus(); return; }
                    const found = findItemById(id);
                    if (found && found.item) {
                        found.item.name = val;
                        saveTasks();
                        renderTasks();
                    } else {
                        // fallback just re-render
                        renderTasks();
                    }
                }

                function cancelEdit(id) {
                    renderTasks();
                }

                // Delete an item (task or subtask) by id
                function deleteItemById(id) {
                    if (!confirm('Remover esta tarefa/subtarefa?')) return;
                    const found = findItemById(id);
                    if (found && found.parentArray) {
                        const idx = found.parentArray.indexOf(found.item);
                        if (idx >= 0) {
                            found.parentArray.splice(idx, 1);
                            saveTasks();
                            renderTasks();
                        }
                    }
                }

        // --- Resources / Bibliography (IEEE) ---
        function loadResources() {
            const saved = JSON.parse(localStorage.getItem('pestaResources') || 'null');
            let resources = saved || [];

            // If no saved resources, parse existing anchors in the resources tab
            if (!saved) {
                const resAnchors = document.querySelectorAll('#resources a');
                resAnchors.forEach(a => {
                    const title = a.textContent.trim();
                    const url = a.href;
                    resources.push({ authors: '', title, venue: '', year: '', url });
                });
                // Deduplicate by URL
                const uniq = [];
                const seen = new Set();
                resources.forEach(r => {
                    if (!seen.has(r.url)) { seen.add(r.url); uniq.push(r); }
                });
                resources = uniq;
                localStorage.setItem('pestaResources', JSON.stringify(resources));
            }

            window.pestaResources = resources;
            renderResources();
        }

        function renderResources() {
            const resources = window.pestaResources || [];
            const bibList = document.getElementById('bibList');
            if (!bibList) return;
            bibList.innerHTML = resources.map((r, i) => `<li>${formatIEEE(r, i+1)} <button onclick="deleteResource(${i})" style="margin-left:8px;background:transparent;color:#ff6b6b;border:none;cursor:pointer;">üóëÔ∏è</button></li>`).join('');
            // Also update a simple resources list (if you want to show raw links)
            // (left as future improvement)
        }

        function addResource(event) {
            event.preventDefault();
            const authors = document.getElementById('resAuthors').value.trim();
            const title = document.getElementById('resTitle').value.trim();
            const venue = document.getElementById('resVenue').value.trim();
            const year = document.getElementById('resYear').value.trim();
            const url = document.getElementById('resUrl').value.trim();

            if (!title) { alert('T√≠tulo √© obrigat√≥rio'); return; }

            const resources = window.pestaResources || [];
            resources.unshift({ authors, title, venue, year, url });
            window.pestaResources = resources;
            localStorage.setItem('pestaResources', JSON.stringify(resources));
            renderResources();
            document.getElementById('addResourceForm').reset();
        }

        function deleteResource(index) {
            const resources = window.pestaResources || [];
            if (index < 0 || index >= resources.length) return;
            if (!confirm('Remover este recurso?')) return;
            resources.splice(index, 1);
            window.pestaResources = resources;
            localStorage.setItem('pestaResources', JSON.stringify(resources));
            renderResources();
        }

        function formatIEEE(r, num) {
            // Basic IEEE-like formatting. Falls back to available fields.
            const authors = r.authors ? r.authors + ', ' : '';
            const title = r.title ? `"${r.title}," ` : '';
            const venue = r.venue ? r.venue + ', ' : '';
            const year = r.year ? r.year : '';
            const url = r.url ? ` [Online]. Available: ${r.url}.` : '';
            const accessed = ` Accessed: ${new Date().toLocaleDateString('pt-PT')}.`;
            const core = `${authors}${title}${venue}${year}.${url}${accessed}`;
            return core;
        }

        function exportIEEE() {
            const resources = window.pestaResources || [];
            const text = resources.map((r,i) => `[${i+1}] ${stripHtml(formatIEEE(r,i+1))}`).join('\n\n');
            const blob = new Blob([text], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'bibliografia_ieee.txt';
            a.click();
        }

        function stripHtml(input) {
            const div = document.createElement('div');
            div.innerHTML = input;
            return div.textContent || div.innerText || '';
        }
        
        function updateTaskProgress() {
            let total = 0;
            let completed = 0;
            
            for (const taskList of Object.values(tasks)) {
                total += taskList.length;
                completed += taskList.filter(t => t.completed).length;
            }
            
            const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
            const progressBar = document.getElementById('taskProgressBar');
            if (progressBar) {
                progressBar.style.width = percentage + '%';
                progressBar.textContent = percentage + '%';
            }
        }
        
        // ===== FIREBASE SYNC FUNCTIONS =====
        
        async function loadTasksFromFirebase() {
            try {
                const doc = await db.collection('pesta').doc('tasks').get();
                if (doc.exists) {
                    tasks = doc.data().data || createDefaultTasks();
                    tasks = migrateTaskStructure(tasks);
                    // Also save to localStorage as backup
                    localStorage.setItem('pestaTasks', JSON.stringify(tasks));
                    console.log('‚úÖ Tarefas carregadas do Firebase');
                } else {
                    // First time - load from localStorage or create default
                    tasks = JSON.parse(localStorage.getItem('pestaTasks')) || createDefaultTasks();
                    tasks = migrateTaskStructure(tasks);
                    await saveTasksToFirebase();
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar do Firebase:', error);
                // Fallback to localStorage
                tasks = JSON.parse(localStorage.getItem('pestaTasks')) || createDefaultTasks();
                tasks = migrateTaskStructure(tasks);
            }
        }
        
        async function saveTasksToFirebase() {
            if (!firebaseEnabled) {
                localStorage.setItem('pestaTasks', JSON.stringify(tasks));
                return;
            }
            
            try {
                await db.collection('pesta').doc('tasks').set({
                    data: tasks,
                    lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                });
                // Also save to localStorage as backup
                localStorage.setItem('pestaTasks', JSON.stringify(tasks));
                console.log('‚úÖ Tarefas guardadas no Firebase');
            } catch (error) {
                console.error('‚ùå Erro ao guardar no Firebase:', error);
                // Fallback to localStorage only
                localStorage.setItem('pestaTasks', JSON.stringify(tasks));
            }
        }
        
        function saveTasks() {
            saveTasksToFirebase();
            // ensure meta (order/banner) also persisted
            if (categoriesOrder) saveMeta();
        }
        
        function clearAllTasks() {
            if (confirm('Remover todas as tarefas conclu√≠das?')) {
                for (const category in tasks) {
                    tasks[category] = tasks[category].filter(t => !t.completed);
                }
                saveTasks();
                renderTasks();
                updateStats();
            }
        }
        
        // Add Task Modal
        function openAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('open');
        }
        
        function closeAddTaskModal() {
            document.getElementById('addTaskModal').classList.remove('open');
            document.getElementById('addTaskForm').reset();
        }
        
        function addNewTask(event) {
            event.preventDefault();
            
            const category = document.getElementById('taskCategory').value;
            const name = document.getElementById('taskName').value;
            
            const maxId = Math.max(...Object.values(tasks).flat().map(t => t.id), 0);
            const newTask = {
                id: maxId + 1,
                name: name,
                completed: false,
                subtasks: []
            };
            
            if (!tasks[category]) {
                tasks[category] = [];
            }
            tasks[category].push(newTask);
            
            saveTasks();
            closeAddTaskModal();
            renderTasks();
            updateStats();
        }
        
        // Log management
        function addLogEntry(event) {
            event.preventDefault();
            
            const log = {
                id: Date.now(),
                title: document.getElementById('logTitle').value,
                date: document.getElementById('logDate').value,
                subject: document.getElementById('logSubject').value,
                text: document.getElementById('logText').value
            };
            
            logs.unshift(log);
            saveLogs();
            renderLogs();
            updateStats();
            
            document.getElementById('logForm').reset();
            document.getElementById('logDate').valueAsDate = new Date();
            
            alert('‚úÖ Entrada adicionada ao log!');
        }
        
        function renderLogs() {
            const container = document.getElementById('logsContainer');
            
            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <p>Ainda n√£o h√° entradas no log</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">Adiciona a tua primeira entrada acima!</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = logs.map(log => `
                <div class="log-entry" data-log-id="${log.id}">
                    <div class="log-actions">
                        <input type="checkbox" onchange="toggleLogSelection(${log.id})" 
                            style="width: 18px; height: 18px; cursor: pointer; accent-color: #8b5cf6;">
                        <button class="log-action-btn" onclick="deleteLog(${log.id})">üóëÔ∏è</button>
                    </div>
                    <div class="log-header">
                        <div class="log-title">${log.title}</div>
                        <div class="log-date">${formatDate(log.date)}</div>
                    </div>
                    ${log.subject ? `<div class="log-subject">${log.subject}</div>` : ''}
                    <div class="log-text">${log.text}</div>
                </div>
            `).join('');
        }
        
        function filterLogs() {
            const searchTerm = document.getElementById('searchLogs').value.toLowerCase();
            const subjectFilter = document.getElementById('filterSubject').value;
            
            const filtered = logs.filter(log => {
                const matchesSearch = log.title.toLowerCase().includes(searchTerm) || 
                                     log.text.toLowerCase().includes(searchTerm);
                const matchesSubject = !subjectFilter || log.subject === subjectFilter;
                return matchesSearch && matchesSubject;
            });
            
            const container = document.getElementById('logsContainer');
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <p>Nenhum log encontrado</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(log => `
                <div class="log-entry" data-log-id="${log.id}">
                    <div class="log-actions">
                        <input type="checkbox" onchange="toggleLogSelection(${log.id})" 
                            style="width: 18px; height: 18px; cursor: pointer; accent-color: #8b5cf6;">
                        <button class="log-action-btn" onclick="deleteLog(${log.id})">üóëÔ∏è</button>
                    </div>
                    <div class="log-header">
                        <div class="log-title">${log.title}</div>
                        <div class="log-date">${formatDate(log.date)}</div>
                    </div>
                    ${log.subject ? `<div class="log-subject">${log.subject}</div>` : ''}
                    <div class="log-text">${log.text}</div>
                </div>
            `).join('');
        }
        
        function toggleLogSelection(logId) {
            if (selectedLogs.has(logId)) {
                selectedLogs.delete(logId);
            } else {
                selectedLogs.add(logId);
            }
        }
        
        function deleteLog(logId) {
            if (confirm('Apagar esta entrada?')) {
                logs = logs.filter(l => l.id !== logId);
                saveLogs();
                renderLogs();
                updateStats();
            }
        }
        
        function clearAllLogs() {
            if (confirm('‚ö†Ô∏è Isto vai apagar TODOS os logs! Tens a certeza?')) {
                logs = [];
                selectedLogs.clear();
                saveLogs();
                renderLogs();
                updateStats();
            }
        }
        
        function downloadAllLogs() {
            if (logs.length === 0) {
                alert('N√£o h√° logs para exportar!');
                return;
            }
            
            const content = generateLogsMarkdown(logs);
            downloadFile('pesta_logs_completo.md', content);
        }
        
        function downloadSelectedLogs() {
            if (selectedLogs.size === 0) {
                alert('Seleciona pelo menos um log!');
                return;
            }
            
            const selected = logs.filter(l => selectedLogs.has(l.id));
            const content = generateLogsMarkdown(selected);
            downloadFile('pesta_logs_selecionados.md', content);
            
            selectedLogs.clear();
            renderLogs();
        }
        
        function generateLogsMarkdown(logList) {
            let content = `# Log de Desenvolvimento - Projeto PESTA
## Torre Autom√°tica de Airsoft com Computer Vision

**Data de exporta√ß√£o:** ${formatDate(new Date().toISOString().split('T')[0])}
**Total de entradas:** ${logList.length}

---

`;
            
            logList.forEach((log, index) => {
                content += `## ${index + 1}. ${log.title}

**Data:** ${formatDate(log.date)}
${log.subject ? `**Assunto:** ${log.subject}\n` : ''}

${log.text}

---

`;
            });
            
            return content;
        }
        
        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/markdown' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function saveLogs() {
            localStorage.setItem('pestaLogs', JSON.stringify(logs));
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('pt-PT', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }
        
        // Stats
        function updateStats() {
            let totalTasks = 0;
            let completedTasks = 0;
            
            for (const taskList of Object.values(tasks)) {
                totalTasks += taskList.length;
                completedTasks += taskList.filter(t => t.completed).length;
            }
            
            const percentage = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('totalLogs').textContent = logs.length;
            document.getElementById('progressPercent').textContent = percentage + '%';
        }
        
        // ===== FILE MANAGEMENT FUNCTIONS =====
        
        // Setup drag and drop
        const fileUploadArea = document.getElementById('fileUploadArea');
        if (fileUploadArea) {
            fileUploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                fileUploadArea.classList.add('drag-over');
            });
            
            fileUploadArea.addEventListener('dragleave', () => {
                fileUploadArea.classList.remove('drag-over');
            });
            
            fileUploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                fileUploadArea.classList.remove('drag-over');
                const files = e.dataTransfer.files;
                handleFileDrop(files);
            });
        }
        
        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                uploadFiles(files);
            }
        }
        
        function handleFileDrop(files) {
            if (files.length > 0) {
                uploadFiles(files);
            }
        }
        
        async function uploadFiles(files) {
            if (!firebaseEnabled || !storage) {
                alert('‚ö†Ô∏è Firebase Storage n√£o est√° configurado. Configure o Firebase para usar esta funcionalidade.');
                return;
            }
            
            const progressDiv = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const uploadStatus = document.getElementById('uploadStatus');
            
            progressDiv.style.display = 'block';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                uploadStatus.textContent = `A enviar ${file.name} (${i + 1}/${files.length})...`;
                
                try {
                    const storageRef = storage.ref();
                    const fileRef = storageRef.child(`pesta-files/${Date.now()}-${file.name}`);
                    
                    const uploadTask = fileRef.put(file);
                    
                    await new Promise((resolve, reject) => {
                        uploadTask.on('state_changed',
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                progressFill.style.width = progress + '%';
                            },
                            (error) => {
                                console.error('Erro no upload:', error);
                                reject(error);
                            },
                            async () => {
                                const downloadURL = await uploadTask.snapshot.ref.getDownloadURL();
                                
                                // Save metadata to Firestore
                                await db.collection('pesta-files').add({
                                    name: file.name,
                                    size: file.size,
                                    type: file.type,
                                    url: downloadURL,
                                    path: uploadTask.snapshot.ref.fullPath,
                                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });
                                
                                resolve();
                            }
                        );
                    });
                    
                } catch (error) {
                    console.error('Erro ao enviar ficheiro:', error);
                    alert(`Erro ao enviar ${file.name}: ${error.message}`);
                }
            }
            
            uploadStatus.textContent = '‚úÖ Upload conclu√≠do!';
            progressFill.style.width = '100%';
            
            setTimeout(() => {
                progressDiv.style.display = 'none';
                progressFill.style.width = '0%';
                document.getElementById('fileInput').value = '';
            }, 2000);
            
            loadFiles();
        }
        
        async function loadFiles() {
            const container = document.getElementById('filesContainer');
            
            if (!firebaseEnabled || !db) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ö†Ô∏è</div>
                        <p>Firebase n√£o est√° configurado. Configure o Firebase para usar esta funcionalidade.</p>
                    </div>
                `;
                return;
            }
            
            try {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîÑ</div>
                        <p>A carregar ficheiros...</p>
                    </div>
                `;
                
                const snapshot = await db.collection('pesta-files').orderBy('uploadedAt', 'desc').get();
                
                if (snapshot.empty) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÇ</div>
                            <p>Nenhum ficheiro carregado ainda</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const file = doc.data();
                    const fileItem = createFileItem(doc.id, file);
                    container.appendChild(fileItem);
                });
                
            } catch (error) {
                console.error('Erro ao carregar ficheiros:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">‚ùå</div>
                        <p>Erro ao carregar ficheiros: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        function createFileItem(fileId, file) {
            const div = document.createElement('div');
            div.className = 'file-item';
            
            const icon = getFileIcon(file.type, file.name);
            const size = formatFileSize(file.size);
            const date = file.uploadedAt ? new Date(file.uploadedAt.toDate()).toLocaleString('pt-PT') : 'Data desconhecida';
            
            div.innerHTML = `
                <div class="file-info">
                    <div class="file-icon">${icon}</div>
                    <div class="file-details">
                        <div class="file-name">${escapeHtml(file.name)}</div>
                        <div class="file-meta">${size} ‚Ä¢ ${date}</div>
                    </div>
                </div>
                <div class="file-actions">
                    <button class="btn-small" onclick="downloadFile('${file.url}', '${escapeHtml(file.name)}')" title="Descarregar">
                        ‚¨áÔ∏è
                    </button>
                    <button class="btn-small" onclick="viewFile('${file.url}')" title="Ver/Abrir">
                        üëÅÔ∏è
                    </button>
                    <button class="btn-small danger" onclick="deleteFile('${fileId}', '${file.path}')" title="Apagar">
                        üóëÔ∏è
                    </button>
                </div>
            `;
            
            return div;
        }
        
        function getFileIcon(type, name) {
            const ext = name.split('.').pop().toLowerCase();
            
            if (type.includes('pdf') || ext === 'pdf') return 'üìÑ';
            if (type.includes('word') || ext === 'doc' || ext === 'docx') return 'üìù';
            if (type.includes('image') || ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext)) return 'üñºÔ∏è';
            if (type.includes('video') || ['mp4', 'avi', 'mov'].includes(ext)) return 'üé•';
            if (type.includes('zip') || ext === 'zip' || ext === 'rar') return 'üì¶';
            if (ext === 'txt') return 'üìÉ';
            if (['xls', 'xlsx'].includes(ext)) return 'üìä';
            if (['ppt', 'pptx'].includes(ext)) return 'üìΩÔ∏è';
            
            return 'üìé';
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.target = '_blank';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        function viewFile(url) {
            window.open(url, '_blank');
        }
        
        async function deleteFile(fileId, filePath) {
            if (!confirm('Tem a certeza que deseja apagar este ficheiro?')) {
                return;
            }
            
            if (!firebaseEnabled || !storage || !db) {
                alert('Firebase n√£o est√° configurado.');
                return;
            }
            
            try {
                // Delete from Storage
                const storageRef = storage.ref();
                const fileRef = storageRef.child(filePath);
                await fileRef.delete();
                
                // Delete from Firestore
                await db.collection('pesta-files').doc(fileId).delete();
                
                alert('‚úÖ Ficheiro apagado com sucesso!');
                loadFiles();
            } catch (error) {
                console.error('Erro ao apagar ficheiro:', error);
                alert('‚ùå Erro ao apagar ficheiro: ' + error.message);
            }
        }
        
        // Initialize
        document.getElementById('logDate').valueAsDate = new Date();
        updateDeadline();
        updateStats();
        renderTasks();
        loadResources();
        setInterval(updateDeadline, 3600000); // Update every hour
    </script>
</body>
</html>